<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Waves Beat Music</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Waves Beat Music%22,%22short_name%22:%22WavesBeat%22,%22start_url%22:%.%22,%22display%22:%22standalone%22,%22background_color%22:%22#000%22,%22theme_color%22:%22#1DB954%22,%22icons%22:[{%22src%22:%22https://picsum.photos/id/1015/192/192%22,%22sizes%22:%22192x192%22,%22type%22:%22image/png%22}]}">
  <style>
    body { font-family: 'Segoe UI', system-ui, sans-serif; }
    .spotify-green { color: #1DB954; }
    .spotify-bg { background: #1DB954; }
    .glass { background: rgba(30,30,30,0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); }
    .song-card { transition: all 0.25s ease; }
    .song-card:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .nav-active { background: rgba(29,185,84,0.15); color: #1DB954; }
  </style>
</head>
<body class="bg-gradient-to-br from-black via-zinc-950 to-black text-white min-h-screen">

<div class="flex h-screen overflow-hidden">
  <!-- Sidebar -->
  <aside id="sidebar" class="w-72 bg-black/90 border-r border-zinc-800 flex flex-col transition-all duration-300 lg:w-72">
    <div class="p-6 flex items-center gap-3 border-b border-zinc-800">
      <div class="w-10 h-10 spotify-bg rounded-xl flex items-center justify-center text-2xl shadow-md">ðŸŒŠ</div>
      <h1 class="text-2xl font-bold tracking-tight">Waves Beat</h1>
    </div>
    <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
      <button onclick="showView('home')" class="nav-btn w-full text-left px-5 py-3 rounded-xl flex items-center gap-4 nav-active">
        <i class="fa-solid fa-home text-lg"></i> Home
      </button>
      <button onclick="showView('library')" class="nav-btn w-full text-left px-5 py-3 rounded-xl flex items-center gap-4">
        <i class="fa-solid fa-music text-lg"></i> Library
      </button>
      <button onclick="showView('playlists')" class="nav-btn w-full text-left px-5 py-3 rounded-xl flex items-center gap-4">
        <i class="fa-solid fa-list text-lg"></i> Playlists
      </button>
      <button onclick="openUpload()" class="nav-btn w-full text-left px-5 py-3 rounded-xl flex items-center gap-4 mt-6 spotify-green hover:bg-zinc-800">
        <i class="fa-solid fa-cloud-upload text-xl"></i> Upload Song
      </button>
    </nav>
    <div class="p-6 border-t border-zinc-800 flex items-center gap-3 cursor-pointer" onclick="openLogin()">
      <div class="w-10 h-10 spotify-bg rounded-full flex-center text-xl">ðŸ‘¤</div>
      <div class="flex-1">
        <div id="usernameDisplay" class="font-medium">Guest</div>
        <div class="text-xs text-zinc-400 cursor-pointer hover:text-white" onclick="event.stopPropagation(); logout()">Logout</div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto">
    <header class="sticky top-0 z-10 glass px-6 py-4 flex items-center justify-between backdrop-blur-lg">
      <div class="flex items-center gap-4 lg:hidden">
        <button onclick="toggleSidebar()" class="text-2xl"><i class="fa-solid fa-bars"></i></button>
      </div>
      <div class="relative flex-1 max-w-md">
        <input id="searchInput" type="text" placeholder="Search songs..." class="w-full bg-zinc-900 border border-zinc-700 rounded-full py-3 pl-12 focus:outline-none focus:border-[#1DB954]" oninput="filterSongs()"/>
        <i class="fa-solid fa-search absolute left-4 top-3.5 text-zinc-400"></i>
      </div>
      <button onclick="toggleTheme()" class="text-xl px-3"><i id="themeIcon" class="fa-solid fa-moon"></i></button>
    </header>

    <!-- Views -->
    <div id="view-home" class="p-6">
      <h1 class="text-3xl font-bold mb-6">Good evening, <span id="greetName" class="spotify-green">Guest</span></h1>
      <section class="mb-10">
        <h2 class="text-2xl font-semibold mb-4">Recently Played</h2>
        <div id="recentGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
      </section>
      <section>
        <h2 class="text-2xl font-semibold mb-4">From the Cloud</h2>
        <div id="cloudGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
      </section>
    </div>

    <div id="view-library" class="p-6 hidden">
      <h1 class="text-3xl font-bold mb-6">Your Library</h1>
      <div id="libraryList" class="space-y-2"></div>
    </div>

    <div id="view-playlists" class="p-6 hidden">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Your Playlists</h1>
        <button onclick="createPlaylist()" class="spotify-bg px-6 py-3 rounded-full font-medium flex items-center gap-2 hover:brightness-110">
          <i class="fa-solid fa-plus"></i> New Playlist
        </button>
      </div>
      <div id="playlistsGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
    </div>
  </main>
</div>

<!-- Bottom Player -->
<div class="fixed bottom-0 left-0 right-0 h-28 glass border-t border-zinc-800 flex items-center px-6 z-50">
  <div class="flex items-center gap-4 w-80">
    <img id="playerCover" src="https://picsum.photos/80" class="w-16 h-16 rounded-xl object-cover shadow-lg" alt="cover">
    <div class="min-w-0">
      <div id="playerTitle" class="font-semibold truncate">Not playing</div>
      <div id="playerArtist" class="text-sm text-zinc-400 truncate">â€”</div>
    </div>
  </div>

  <div class="flex-1 flex flex-col items-center gap-2">
    <div class="flex items-center gap-8 text-2xl">
      <button id="shuffleBtn" onclick="toggleShuffle()" class="hover:spotify-green transition"><i class="fa-solid fa-shuffle"></i></button>
      <button onclick="prevSong()" class="hover:spotify-green transition"><i class="fa-solid fa-backward-step"></i></button>
      <button id="playBtn" onclick="togglePlay()" class="w-14 h-14 spotify-bg rounded-full flex items-center justify-center shadow-xl hover:scale-105 transition text-black">
        <i class="fa-solid fa-play"></i>
      </button>
      <button onclick="nextSong()" class="hover:spotify-green transition"><i class="fa-solid fa-forward-step"></i></button>
      <button id="repeatBtn" onclick="toggleRepeat()" class="hover:spotify-green transition"><i class="fa-solid fa-repeat"></i></button>
    </div>
    <div class="w-full max-w-lg flex items-center gap-3 text-sm">
      <span id="currentTime">0:00</span>
      <input id="progress" type="range" min="0" max="100" value="0" class="flex-1 accent-[#1DB954]" oninput="seek()"/>
      <span id="duration">0:00</span>
    </div>
  </div>

  <div class="flex items-center gap-6 w-80 justify-end">
    <button onclick="toggleVisualizer()" class="text-xl hover:spotify-green"><i class="fa-solid fa-waveform-lines"></i></button>
    <div class="flex items-center gap-3">
      <i class="fa-solid fa-volume-high text-lg"></i>
      <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8" class="w-32 accent-[#1DB954]" oninput="setVolume()"/>
    </div>
  </div>
</div>

<!-- Visualizer Modal -->
<div id="vizModal" class="hidden fixed inset-0 bg-black/95 flex items-center justify-center z-50">
  <div class="text-center">
    <canvas id="vizCanvas" width="800" height="400" class="rounded-2xl shadow-2xl bg-black/50"></canvas>
    <button onclick="toggleVisualizer()" class="mt-6 px-10 py-4 bg-zinc-800 rounded-full hover:bg-zinc-700">Close</button>
  </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
  <div class="glass p-10 rounded-2xl w-full max-w-md text-center">
    <h2 class="text-2xl font-bold mb-6 spotify-green">Upload to Cloud</h2>
    <input id="fileInput" type="file" accept="audio/*" multiple class="hidden" onchange="handleFiles(event)"/>
    <button onclick="document.getElementById('fileInput').click()" class="w-full py-20 border-4 border-dashed border-[#1DB954]/60 rounded-2xl hover:border-[#1DB954] transition">
      <i class="fa-solid fa-cloud-upload-alt text-7xl spotify-green mb-4"></i>
      <p class="text-xl font-medium">Click or drop songs here</p>
      <p class="text-sm text-zinc-400 mt-2">MP3, WAV supported</p>
    </button>
    <button onclick="closeUpload()" class="mt-8 text-zinc-400 hover:text-white">Cancel</button>
  </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
  <div class="glass p-10 rounded-2xl w-full max-w-sm">
    <h2 class="text-2xl font-bold mb-6 text-center">Welcome to Waves Beat</h2>
    <input id="loginInput" type="text" placeholder="Enter your name" class="w-full bg-zinc-900 border border-zinc-700 rounded-full py-4 px-6 text-center focus:outline-none focus:border-[#1DB954]"/>
    <button onclick="login()" class="mt-6 w-full spotify-bg py-4 rounded-full font-bold text-black">Continue</button>
  </div>
</div>

<audio id="audio" preload="auto"></audio>

<script>
const audio = document.getElementById('audio');
let audioCtx = null, analyser = null, source = null, dataArray = null;
let songs = [], currentIndex = -1, isPlaying = false;
let shuffle = false, repeat = 'off'; // 'off', 'all', 'one'
let username = localStorage.getItem('wavesUsername') || 'Guest';
let theme = localStorage.getItem('wavesTheme') || 'dark';

document.getElementById('usernameDisplay').textContent = username;
document.getElementById('greetName').textContent = username;

const demoSongs = [
  { id: 1, title: "Song One", artist: "SoundHelix", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3", cover: "https://picsum.photos/seed/music1/300/300", duration: "3:45" },
  { id: 2, title: "Song Two", artist: "SoundHelix", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3", cover: "https://picsum.photos/seed/music2/300/300", duration: "4:10" },
  { id: 3, title: "Song Three", artist: "SoundHelix", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3", cover: "https://picsum.photos/seed/music3/300/300", duration: "3:30" },
  { id: 4, title: "Song Four", artist: "SoundHelix", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3", cover: "https://picsum.photos/seed/music4/300/300", duration: "5:00" },
];

songs = JSON.parse(localStorage.getItem('wavesSongs')) || [...demoSongs];

function initAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 128;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
}

function connectAudio() {
  if (source) source.disconnect();
  source = audioCtx.createMediaElementSource(audio);
  source.connect(analyser);
  analyser.connect(audioCtx.destination);
}

function drawVisualizer() {
  if (!isPlaying || audioCtx?.state !== 'running') return;
  requestAnimationFrame(drawVisualizer);
  analyser.getByteFrequencyData(dataArray);
  const canvas = document.getElementById('vizCanvas');
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  const barWidth = (canvas.width / dataArray.length) * 2.5;
  let x = 0;
  for (let i = 0; i < dataArray.length; i++) {
    const barHeight = (dataArray[i] / 255) * canvas.height;
    ctx.fillStyle = `hsl(${i * 4 + 140}, 100%, 60%)`;
    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
    x += barWidth + 4;
  }
}

function playSong(index) {
  if (index < 0 || index >= songs.length) return;
  currentIndex = index;
  const song = songs[index];
  audio.src = song.src;
  initAudioContext();
  audio.play().then(() => {
    isPlaying = true;
    document.getElementById('playBtn').innerHTML = '<i class="fa-solid fa-pause"></i>';
    document.getElementById('playerCover').src = song.cover;
    document.getElementById('playerTitle').textContent = song.title;
    document.getElementById('playerArtist').textContent = song.artist;
    connectAudio();
    drawVisualizer();
    addToRecent(song.id);
  }).catch(err => console.error("Play error:", err));
}

function togglePlay() {
  initAudioContext();
  if (isPlaying) {
    audio.pause();
    isPlaying = false;
    document.getElementById('playBtn').innerHTML = '<i class="fa-solid fa-play"></i>';
  } else if (currentIndex >= 0) {
    audio.play();
    isPlaying = true;
    document.getElementById('playBtn').innerHTML = '<i class="fa-solid fa-pause"></i>';
    drawVisualizer();
  }
}

function nextSong() {
  let next = currentIndex + 1;
  if (next >= songs.length) next = 0;
  playSong(next);
}

function prevSong() {
  let prev = currentIndex - 1;
  if (prev < 0) prev = songs.length - 1;
  playSong(prev);
}

audio.ontimeupdate = () => {
  if (!audio.duration) return;
  document.getElementById('progress').value = (audio.currentTime / audio.duration) * 100;
  document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
  document.getElementById('duration').textContent = formatTime(audio.duration);
};

audio.onended = () => {
  if (repeat === 'one') {
    audio.currentTime = 0;
    audio.play();
  } else {
    nextSong();
  }
};

function seek() {
  if (audio.duration) audio.currentTime = (document.getElementById('progress').value / 100) * audio.duration;
}

function setVolume() {
  audio.volume = document.getElementById('volume').value;
}

function formatTime(sec) {
  if (!sec) return "0:00";
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return `${m}:${s.toString().padStart(2, '0')}`;
}

function toggleShuffle() {
  shuffle = !shuffle;
  document.getElementById('shuffleBtn').classList.toggle('spotify-green', shuffle);
}

function toggleRepeat() {
  if (repeat === 'off') {
    repeat = 'all';
    document.getElementById('repeatBtn').classList.add('spotify-green');
  } else if (repeat === 'all') {
    repeat = 'one';
    document.getElementById('repeatBtn').innerHTML = '<i class="fa-solid fa-repeat"></i><span class="text-xs absolute -top-1 right-0 bg-red-500 rounded-full px-1">1</span>';
  } else {
    repeat = 'off';
    document.getElementById('repeatBtn').innerHTML = '<i class="fa-solid fa-repeat"></i>';
    document.getElementById('repeatBtn').classList.remove('spotify-green');
  }
}

function handleFiles(e) {
  Array.from(e.target.files).forEach(file => {
    const url = URL.createObjectURL(file);
    const tempAudio = new Audio(url);
    tempAudio.onloadedmetadata = () => {
      const newSong = {
        id: Date.now(),
        title: file.name.replace(/\.[^/.]+$/, ""),
        artist: "Uploaded",
        src: url,
        cover: "https://picsum.photos/seed/uploaded/300/300",
        duration: formatTime(tempAudio.duration)
      };
      songs.push(newSong);
      localStorage.setItem('wavesSongs', JSON.stringify(songs));
      renderLibrary();
      renderCloud();
      closeUpload();
      playSong(songs.length - 1);
    };
  });
}

function deleteSong(id) {
  if (confirm("Delete this song?")) {
    songs = songs.filter(s => s.id !== id);
    localStorage.setItem('wavesSongs', JSON.stringify(songs));
    renderLibrary();
    renderCloud();
  }
}

function addToRecent(id) {
  let recents = JSON.parse(localStorage.getItem('wavesRecents')) || [];
  recents = recents.filter(r => r !== id);
  recents.unshift(id);
  if (recents.length > 10) recents.pop();
  localStorage.setItem('wavesRecents', JSON.stringify(recents));
  renderRecent();
}

function renderRecent() {
  const recents = JSON.parse(localStorage.getItem('wavesRecents')) || [];
  const container = document.getElementById('recentGrid');
  container.innerHTML = '';
  recents.forEach(id => {
    const song = songs.find(s => s.id === id);
    if (song) container.appendChild(createCard(song, songs.indexOf(song)));
  });
}

function renderCloud() {
  const container = document.getElementById('cloudGrid');
  container.innerHTML = '';
  demoSongs.forEach(s => container.appendChild(createCard(s, songs.findIndex(song => song.id === s.id))));
}

function renderLibrary() {
  const container = document.getElementById('libraryList');
  container.innerHTML = '';
  songs.forEach((song, idx) => {
    const div = document.createElement('div');
    div.className = 'flex items-center gap-4 p-4 bg-zinc-900/50 rounded-xl hover:bg-zinc-800 song-card';
    div.innerHTML = `
      <img src="${song.cover}" class="w-12 h-12 rounded-lg object-cover">
      <div class="flex-1">
        <div class="font-medium">${song.title}</div>
        <div class="text-sm text-zinc-400">${song.artist}</div>
      </div>
      <div class="text-sm text-zinc-500">${song.duration || '--:--'}</div>
      <button onclick="event.stopPropagation(); playSong(${idx})" class="px-6 py-2 spotify-bg text-black rounded-full text-sm">Play</button>
      <button onclick="event.stopPropagation(); deleteSong(${song.id})" class="px-3 py-2 text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
    `;
    div.onclick = () => playSong(idx);
    container.appendChild(div);
  });
}

function createCard(song, index) {
  const div = document.createElement('div');
  div.className = 'song-card bg-zinc-900/50 rounded-xl overflow-hidden cursor-pointer';
  div.innerHTML = `
    <img src="${song.cover}" class="w-full aspect-square object-cover">
    <div class="p-4">
      <div class="font-medium truncate">${song.title}</div>
      <div class="text-sm text-zinc-400">${song.artist}</div>
    </div>
  `;
  div.onclick = () => playSong(index);
  return div;
}

function createPlaylist() {
  const name = prompt("Playlist name?");
  if (!name) return;
  let playlists = JSON.parse(localStorage.getItem('wavesPlaylists')) || [];
  playlists.push({ name, songs: [] });
  localStorage.setItem('wavesPlaylists', JSON.stringify(playlists));
  renderPlaylists();
}

function renderPlaylists() {
  const container = document.getElementById('playlistsGrid');
  container.innerHTML = '';
  const playlists = JSON.parse(localStorage.getItem('wavesPlaylists')) || [];
  playlists.forEach(pl => {
    const div = document.createElement('div');
    div.className = 'bg-zinc-900/50 rounded-xl p-6 text-center cursor-pointer hover:bg-zinc-800 song-card';
    div.innerHTML = `
      <div class="text-6xl mb-4">ðŸ“‚</div>
      <div class="font-bold text-xl">${pl.name}</div>
      <div class="text-sm text-zinc-400">${pl.songs.length} songs</div>
    `;
    div.onclick = () => alert(`Open playlist: ${pl.name} (add/remove coming with backend)`);
    container.appendChild(div);
  });
}

function filterSongs() {
  const term = document.getElementById('searchInput').value.toLowerCase();
  // Simple filter on library view for now
  renderLibrary(); // can enhance to filter
}

function showView(view) {
  document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
  document.getElementById(`view-${view}`).classList.remove('hidden');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
  event.target.classList.add('nav-active');
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('w-0', 'lg:w-72');
}

function openUpload() { document.getElementById('uploadModal').classList.remove('hidden'); }
function closeUpload() { document.getElementById('uploadModal').classList.add('hidden'); }

function openLogin() { document.getElementById('loginModal').classList.remove('hidden'); }
function login() {
  username = document.getElementById('loginInput').value.trim() || 'Guest';
  localStorage.setItem('wavesUsername', username);
  document.getElementById('usernameDisplay')
